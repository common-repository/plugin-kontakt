<?php	// Functions	function getField($array, $search) {		$return = "";				for($i = 0; $i < count($array); $i++) {			if(array_key_exists($search, $array[$i])) {				$return = $array[$i][$search];				break;			}		}				return $return;	}		// Delete	$delete = explode(";", $_POST['delete_data']);	foreach($delete AS $id) {		if(is_numeric($id) && $id != "") {			$wpdb->query("DELETE FROM `" . $wpdb->prefix . "kontakt_fields` WHERE id='" . $id . "' LIMIT 1");		}	}		// Update	foreach($_POST AS $name => $value) {		if(preg_match("/field_([0-9]+)_(.*)/mi", $name)) {			$data = explode("[LINE]", preg_replace("/field_([0-9]+)_(.*)/mi", "$1[LINE]$2", $name));			$id = $data[0];			switch($data[1]) {				case "type":					$wpdb->query("UPDATE `" . $wpdb->prefix . "kontakt_fields` SET `type`='" . $value . "' WHERE id='" . $id . "' LIMIT 1");				break;				case "name":					$wpdb->query("UPDATE `" . $wpdb->prefix . "kontakt_fields` SET `name`='" . $value . "' WHERE id='" . $id . "' LIMIT 1");				break;				case "required":					$wpdb->query("UPDATE `" . $wpdb->prefix . "kontakt_fields` SET `required`='" . $value . "' WHERE id='" . $id . "' LIMIT 1");				break;				case "required_data":					$wpdb->query("UPDATE `" . $wpdb->prefix . "kontakt_fields` SET `required_data`='" . $value . "' WHERE id='" . $id . "' LIMIT 1");				break;				case "value":					$wpdb->query("UPDATE `" . $wpdb->prefix . "kontakt_fields` SET `value`='" . $value . "' WHERE id='" . $id . "' LIMIT 1");				break;				case "order":					$wpdb->query("UPDATE `" . $wpdb->prefix . "kontakt_fields` SET `order`='" . $value . "' WHERE id='" . $id . "' LIMIT 1");				break;				case "subject_data":					$wpdb->query("UPDATE `" . $wpdb->prefix . "kontakt_fields` SET `subject_data`='" . $value . "' WHERE id='" . $id . "' LIMIT 1");				break;			}		}	}		// Create	$new = array();	foreach($_POST AS $name => $value) {		if(preg_match("/field_new_([0-9]+)_(.*)/mi", $name)) {			$data = explode("[LINE]", preg_replace("/field_new_([0-9]+)_(.*)/mi", "$1[LINE]$2", $name));			$id = $data[0];			switch($data[1]) {				case "type":					$new[$id][] = array("type" => $value);				break;				case "name":					$new[$id][] = array("name" => $value);				break;				case "required":					$new[$id][] = array("required" => $value);				break;				case "required_data":					$new[$id][] = array("required_data" => $value);				break;				case "value":					$new[$id][] = array("value" => $value);				break;				case "order":					$new[$id][] = array("order" => $value);				break;			}		}	}		$newest = array();	foreach($new AS $id => $data) {		$newest[] = array(			"id"			=> $id,			"type"			=> getField($data, "type"),			"name"			=> getField($data, "name"),			"required"		=> getField($data, "required"),			"required_data"	=> getField($data, "required_data"),			"value"			=> getField($data, "value"),			"order"			=> getField($data, "order"),		);	}		for($i = 0; $i < count($newest); $i++) {		$wpdb->query("INSERT INTO `" . $wpdb->prefix . "kontakt_fields` (`id`, `type`, `name`, `value`, `required`, `required_data`, `order`) VALUES (null, '" . $newest[$i]['type'] . "', '" . $newest[$i]['name'] . "', '" . $newest[$i]['value'] . "', '" . $newest[$i]['required'] . "', '" . $newest[$i]['required_data'] . "', '" . $newest[$i]['order'] . "')");	}		// Order	if(isset($_POST['order_data']) && $_POST['order_data'] != "") {		// Up		if(preg_match("/UP_([0-9]+)/mi", $_POST['order_data'])) {			$id			= str_replace("UP_", "", $_POST['order_data']);			$sql		= $wpdb->get_results("SELECT `order` FROM `" . $wpdb->prefix . "kontakt_fields` WHERE `id`='" . $id . "' LIMIT 1");			$sortierung	= $sql[0]->order;			$sql		= $wpdb->get_results("SELECT `id` FROM `" . $wpdb->prefix . "kontakt_fields` WHERE `order`='" . ($sortierung + 1) . "' LIMIT 1");			$newId		= $sql[0]->id;			$wpdb->query("UPDATE `" . $wpdb->prefix . "kontakt_fields` SET `order` = `order` + 1 WHERE `id`='" . $id . "'");			$wpdb->query("UPDATE `" . $wpdb->prefix . "kontakt_fields` SET `order` = `order` - 1 WHERE `id`='" . $newId . "'");		// Down		} else if(preg_match("/DOWN_([0-9]+)/mi", $_POST['order_data'])) {			$id			= str_replace("DOWN_", "", $_POST['order_data']);			$sql		= $wpdb->get_results("SELECT `order` FROM `" . $wpdb->prefix . "kontakt_fields` WHERE `id`='" . $id . "' LIMIT 1");			$sortierung	= $sql[0]->order;			$sql		= $wpdb->get_results("SELECT `id` FROM `" . $wpdb->prefix . "kontakt_fields` WHERE `order`='" . ($sortierung - 1) . "' LIMIT 1");			$newId		= $sql[0]->id;			$wpdb->query("UPDATE `" . $wpdb->prefix . "kontakt_fields` SET `order` = `order` - 1 WHERE `id`='" . $id . "'");			$wpdb->query("UPDATE `" . $wpdb->prefix . "kontakt_fields` SET `order` = `order` + 1 WHERE `id`='" . $newId . "'");		}	}	#print_r($_POST['order_data']);	#print_r($_POST['last_order']);	// Redirect	wp_redirect("options-general.php?page=plugin_kontakt&site=form&notify=save");	exit();?>